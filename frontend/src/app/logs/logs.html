<div class="min-vh-100 w-100 position-relative overflow-hidden">

  <!-- Background -->
  <div class="position-absolute top-0 start-0 w-100 h-100"
       style="background:
         radial-gradient(circle at 15% 20%, rgba(13,110,253,.16), transparent 45%),
         radial-gradient(circle at 85% 30%, rgba(220,53,69,.12), transparent 40%),
         radial-gradient(circle at 50% 90%, rgba(25,135,84,.14), transparent 45%);">
  </div>

  <div class="container-fluid position-relative py-4 px-3 px-lg-4" style="z-index:5;">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
      <div>
        <h4 class="fw-bold mb-0">Audit Logs</h4>
        <div class="text-muted small">Enterprise monitoring • Security events • System actions</div>
      </div>

      <button class="btn btn-outline-secondary rounded-3" (click)="refresh()">
        <i class="bi bi-arrow-clockwise me-2"></i>Refresh
      </button>
    </div>

    <!-- Error -->
    <div *ngIf="errorMsg" class="alert alert-danger rounded-3">
      <i class="bi bi-exclamation-triangle me-2"></i>{{ errorMsg }}
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="text-muted d-flex align-items-center gap-2 mb-3">
      <span class="spinner-border spinner-border-sm"></span>
      Loading audit logs...
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm rounded-4 mb-4" *ngIf="!loading">
      <div class="card-body p-4">

        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-6 col-xl-5">
            <label class="form-label small fw-semibold text-muted">Search</label>
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input class="form-control"
                     placeholder="Search by user / action / ID / details"
                     [value]="search"
                     (input)="onSearch($any($event.target).value)">
            </div>
          </div>

          <div class="col-6 col-md-3 col-xl-3">
            <label class="form-label small fw-semibold text-muted">Action</label>
            <select class="form-select" [(ngModel)]="actionFilter" (change)="applyFilters()">
              <option value="all">All</option>
              <option value="LOGIN">Login</option>
              <option value="LOGOUT">Logout</option>
              <option value="CREATE_QUOTATION">Quotation Created</option>
              <option value="DOWNLOAD_PDF">PDF Downloaded</option>
              <option value="SEND_EMAIL">Email Sent</option>
              <option value="DELETE_QUOTATION">Quotation Deleted</option>
              <option value="UPDATE_PRICING">Pricing Updated</option>
            </select>
          </div>

          <div class="col-6 col-md-3 col-xl-2">
            <label class="form-label small fw-semibold text-muted">Sort</label>
            <select class="form-select" [(ngModel)]="sortBy" (change)="applyFilters()">
              <option value="latest">Latest</option>
              <option value="oldest">Oldest</option>
            </select>
          </div>

          <div class="col-12 col-xl-2 d-flex justify-content-xl-end">
            <span class="badge rounded-pill text-bg-primary px-4 py-2">
              Showing {{ filtered.length }}
            </span>
          </div>
        </div>

      </div>
    </div>

    <!-- Logs Table -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden" *ngIf="!loading">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Action</th>
              <th>User</th>
              <th>Details</th>
              <th>Date</th>
              <th class="text-end">View</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let log of pageRows; trackBy: trackById" class="click-row" (click)="openLog(log)">
              <td class="fw-semibold">#{{ log.id }}</td>

              <td class="fw-semibold">
                <span class="badge rounded-pill text-bg-dark px-3 py-2">
                  {{ actionLabel(log.action) }}
                </span>
              </td>

              <td class="fw-semibold">{{ log.username || '—' }}</td>
              <td class="text-muted small">{{ log.details || '—' }}</td>
              <td class="text-muted small">{{ log.created_at | date:'medium' }}</td>

              <td class="text-end" (click)="$event.stopPropagation()">
                <button class="btn btn-outline-secondary btn-sm rounded-3" (click)="openLog(log)">
                  <i class="bi bi-eye me-1"></i>View
                </button>
              </td>
            </tr>

            <tr *ngIf="filtered.length === 0">
              <td colspan="6" class="text-center text-muted py-5">
                <div class="display-6 mb-2"><i class="bi bi-inbox"></i></div>
                <div class="fw-semibold">No logs found</div>
                <div class="small">Try changing search or filters.</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="border-top bg-white p-3 d-flex justify-content-between align-items-center flex-wrap gap-2"
           *ngIf="filtered.length > 0">
        <div class="text-muted small">
          Page {{ page }} / {{ totalPages }}
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm rounded-3"
                  [disabled]="page === 1"
                  (click)="goPage(page - 1)">
            <i class="bi bi-chevron-left"></i>
          </button>

          <button class="btn btn-outline-secondary btn-sm rounded-3"
                  [disabled]="page === totalPages"
                  (click)="goPage(page + 1)">
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>

    </div>

    <!-- ✅ Modal -->
    <div *ngIf="showModal"
         class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
         style="background: rgba(0,0,0,.55); z-index: 9999;"
         (click)="closeModal()">

      <div class="bg-white rounded-4 shadow-lg p-4"
           style="width:min(760px, 95vw);"
           (click)="$event.stopPropagation()">

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h5 class="fw-bold mb-0">Audit Log Details</h5>
            <div class="text-muted small">Log #{{ selectedLog?.id }}</div>
          </div>

          <button class="btn btn-outline-secondary rounded-3" (click)="closeModal()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="border rounded-4 p-3 bg-light">
              <div class="text-muted small">Action</div>
              <div class="fw-bold">{{ actionLabel(selectedLog?.action || '') }}</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="border rounded-4 p-3 bg-light">
              <div class="text-muted small">User</div>
              <div class="fw-bold">{{ selectedLog?.username || '—' }}</div>
            </div>
          </div>

          <div class="col-md-12">
            <div class="border rounded-4 p-3 bg-light">
              <div class="text-muted small">Details</div>
              <div class="fw-semibold">{{ selectedLog?.details || '—' }}</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="border rounded-4 p-3 bg-light">
              <div class="text-muted small">IP Address</div>
              <div class="fw-semibold">{{ selectedLog?.ip_address || '—' }}</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="border rounded-4 p-3 bg-light">
              <div class="text-muted small">Date</div>
              <div class="fw-semibold">{{ selectedLog?.created_at | date:'full' }}</div>
            </div>
          </div>

        </div>

      </div>
    </div>

  </div>
</div>
